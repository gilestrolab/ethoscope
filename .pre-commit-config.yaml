# Pre-commit hooks for Ethoscope project
# See https://pre-commit.com for more information
# Install: pip install pre-commit && pre-commit install
# Run manually: pre-commit run --all-files

default_language_version:
  python: python3

repos:
  # ===== General file checks =====
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
        exclude: ^(.*\.md|.*\.txt)$
      - id: end-of-file-fixer
        exclude: ^(.*\.txt|.*\.csv|.*\.dat)$
      - id: check-yaml
        args: ['--unsafe']  # Allow custom YAML tags
      - id: check-json
      - id: check-toml
      - id: check-added-large-files
        args: ['--maxkb=2000']
      - id: check-merge-conflict
      - id: check-case-conflict
      - id: check-docstring-first
        exclude: ^(src/node/test_notifications\.py|src/ethoscope/scripts/device_server\.py|src/ethoscope/docs/conf\.py|src/ethoscope/ethoscope/tests/unit/test_dbappender\.py)$
      - id: check-executables-have-shebangs
      - id: debug-statements
        exclude: ^(src/ethoscope/ethoscope/trackers/multi_fly_tracker\.py)$  # Uses matplotlib for debugging
      - id: mixed-line-ending
        args: ['--fix=lf']
      - id: name-tests-test
        args: ['--pytest-test-first']
        exclude: ^(.*fixtures.*|.*conftest\.py|.*helpers\.py|.*mocks\.py|.*mock_.*\.py|.*test_notifications\.py|.*run_.*_tests\.py|.*utils\.py|.*check_field\.py|.*_constants\.py)$

  # ===== Python code formatting =====
  - repo: https://github.com/psf/black
    rev: 24.1.1
    hooks:
      - id: black
        language_version: python3
        args: ['--line-length=88']
        files: ^(src/|scripts/|run_tests\.py).*\.py$

  # ===== Import sorting =====
  - repo: https://github.com/PyCQA/isort
    rev: 5.13.2
    hooks:
      - id: isort
        args: ['--profile', 'black', '--line-length', '88']
        files: ^(src/|scripts/|run_tests\.py).*\.py$

  # ===== Modern Python linting with ruff =====
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.1.14
    hooks:
      - id: ruff
        args: ['--fix']
        files: ^(src/|scripts/|run_tests\.py).*\.py$
        exclude: ^(.*docs/conf\.py)$

  # ===== Traditional Python linting with flake8 =====
  - repo: https://github.com/PyCQA/flake8
    rev: 7.0.0
    hooks:
      - id: flake8
        args: [
          '--max-line-length=88',
          '--extend-ignore=E203,W503',  # Conflicts with black formatter
          '--max-complexity=15'
        ]
        files: ^(src/|scripts/|run_tests\.py).*\.py$
        exclude: ^(.*docs/conf\.py)$

  # ===== Security checks =====
  - repo: https://github.com/PyCQA/bandit
    rev: 1.7.6
    hooks:
      - id: bandit
        args: ['-ll', '-i', '--skip=B310,B605,B608,B307,B108,B306,B324,B104,B602,B301']  # Skip informational/false positives
        files: ^src/.*\.py$
        exclude: ^(.*test.*\.py|.*conftest\.py)$

  # ===== Detect secrets =====
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.4.0
    hooks:
      - id: detect-secrets
        args: ['--baseline', '.secrets.baseline']
        exclude: (package.lock.json|.*\.ipynb)

  # ===== YAML linting =====
  - repo: https://github.com/adrienverge/yamllint
    rev: v1.33.0
    hooks:
      - id: yamllint
        args: ['-d', '{extends: default, rules: {line-length: {max: 160}, document-start: disable, indentation: {indent-sequences: consistent}, brackets: {max-spaces-inside: 1}, comments: disable}}']
        files: \.(yaml|yml)$
        exclude: ^(.github/workflows/.*\.yml|\.pre-commit-config\.yaml)$

  # ===== Shell script linting =====
  - repo: https://github.com/shellcheck-py/shellcheck-py
    rev: v0.9.0.6
    hooks:
      - id: shellcheck
        args: ['--severity=error']  # Only fail on errors, not warnings
        files: \.(sh|bash)$

  # ===== Local custom hooks =====
  - repo: local
    hooks:
      - id: python-check-syntax
        name: Check Python syntax
        entry: python
        language: system
        args: [-m, py_compile]
        files: \.py$

      - id: python-import-check
        name: Check Python imports (requires venv)
        entry: bash
        language: system
        args:
          - -c
          - |
            if [ -f .venv/bin/activate ]; then
              source .venv/bin/activate
              for file in "$@"; do
                python -c "import sys; import importlib.util; spec = importlib.util.spec_from_file_location('module', '$file'); module = importlib.util.module_from_spec(spec); spec.loader.exec_module(module)" 2>&1 && echo "✓ $file" || {
                  echo "✗ $file: Import failed"
                  echo "  Hint: Check if all imports can resolve - may be missing dependencies or cross-package imports"
                  exit 1
                }
              done
            else
              echo "⚠ Skipping import check (venv not found at .venv)"
              echo "  Hint: Create venv with: python -m venv .venv && source .venv/bin/activate && pip install -e src/ethoscope[dev] && pip install -e src/node[dev]"
            fi
        files: ^(src/|scripts/).*\.py$
        pass_filenames: true
        stages: [pre-commit]

      - id: validate-cross-package-imports
        name: Validate no cross-package imports (maintain package independence)
        entry: bash
        language: system
        args:
          - -c
          - |
            echo "Checking for cross-package imports between ethoscope and ethoscope_node..."
            EXIT_CODE=0

            # Check if node package imports from ethoscope package
            # Only match lines that start with 'from' or 'import' (allowing leading whitespace)
            if grep -rE "^[[:space:]]*(from ethoscope\.|import ethoscope)" src/node/ethoscope_node/ --include="*.py" 2>/dev/null; then
              echo "❌ ERROR: Node package (ethoscope_node) imports from device package (ethoscope)"
              echo "   This creates a cross-package dependency that breaks package independence."
              echo ""
              echo "   Found imports:"
              grep -rnE "^[[:space:]]*(from ethoscope\.|import ethoscope)" src/node/ethoscope_node/ --include="*.py" 2>/dev/null || true
              echo ""
              echo "   Fix options:"
              echo "   1. Copy the needed utility function to ethoscope_node package"
              echo "   2. Extract shared code to a common utilities package"
              echo "   3. If dependency is intentional, declare 'ethoscope' in src/node/pyproject.toml dependencies"
              EXIT_CODE=1
            fi

            # Check if ethoscope package imports from node package (reverse dependency)
            if grep -rE "^[[:space:]]*(from ethoscope_node\.|import ethoscope_node)" src/ethoscope/ethoscope/ --include="*.py" 2>/dev/null; then
              echo "❌ ERROR: Device package (ethoscope) imports from node package (ethoscope_node)"
              echo "   This creates a reverse dependency that breaks package architecture."
              echo ""
              echo "   Found imports:"
              grep -rnE "^[[:space:]]*(from ethoscope_node\.|import ethoscope_node)" src/ethoscope/ethoscope/ --include="*.py" 2>/dev/null || true
              echo ""
              echo "   Fix: Remove these imports - device package should not depend on node package"
              EXIT_CODE=1
            fi

            if [ $EXIT_CODE -eq 0 ]; then
              echo "✓ No cross-package imports detected - packages are independent"
            fi

            exit $EXIT_CODE
        files: ^src/.*\.(py|toml)$
        pass_filenames: false
        stages: [pre-commit]

      - id: critical-tests
        name: Run tests for critical changes
        entry: bash
        language: system
        args:
          - -c
          - |
            if echo "$PRE_COMMIT_FROM_REF $PRE_COMMIT_TO_REF" | grep -E "(monitor|tracker|stimulator)"; then
              echo "Critical files changed, running relevant tests..."
              if [ -f .venv/bin/activate ]; then
                cd src/ethoscope && source ../../.venv/bin/activate && python -m pytest ethoscope/tests/unittests/ -v --tb=short -x
              else
                echo "⚠ Skipping tests (venv not found)"
              fi
            else
              echo "No critical files changed, skipping tests"
            fi
        files: ^src/ethoscope/ethoscope/(core|trackers|stimulators)/.*\.py$
        pass_filenames: false
        stages: [manual]  # Only run when explicitly called

      - id: update-copyright
        name: Update copyright year
        entry: bash
        language: system
        args:
          - -c
          - |
            YEAR=$(date +%Y)
            for file in "$@"; do
              if grep -q "Copyright.*Giorgio Gilestro" "$file"; then
                sed -i "s/Copyright \(.*\) Giorgio Gilestro/Copyright (c) $YEAR Giorgio Gilestro/" "$file"
                echo "Updated copyright in $file"
              fi
            done
        files: ^src/.*\.py$
        pass_filenames: true
        stages: [manual]

# CI configuration for pre-commit.ci
ci:
  autofix_commit_msg: |
    [pre-commit.ci] auto fixes from pre-commit hooks

    for more information, see https://pre-commit.ci
  autofix_prs: true
  autoupdate_branch: 'dev'
  autoupdate_commit_msg: '[pre-commit.ci] pre-commit autoupdate'
  autoupdate_schedule: monthly
  skip: [critical-tests, update-copyright]
  submodules: false
