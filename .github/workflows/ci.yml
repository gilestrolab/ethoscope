name: CI

on:
  push:
    branches: [ dev, main ]
  pull_request:
    branches: [ dev, main ]
  workflow_dispatch:

jobs:
  test-device:
    name: Test Device Package (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # Test only versions used in deployment:
        # - Python 3.9: Raspbian Bullseye (Ethoscope devices)
        # - Python 3.11: Raspbian Bookworm & Arch Linux (Node server)
        # - Python 3.12: Latest Arch Linux (Node server)
        python-version: ['3.9', '3.11', '3.12']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libopencv-dev \
          python3-opencv \
          libatlas-base-dev \
          libhdf5-dev \
          libcap-dev

    - name: Install device package with dependencies
      run: |
        cd src/ethoscope
        pip install --upgrade pip setuptools wheel
        pip install -e .[dev,testing]

    - name: Run device unit tests
      run: |
        cd src/ethoscope
        python -m pytest ethoscope/tests/unittests/ \
          -v \
          --tb=short \
          --strict-markers \
          --strict-config \
          --no-cov \
          --junit-xml=junit-device-unit-${{ matrix.python-version }}.xml

    - name: Run device integration tests
      run: |
        cd src/ethoscope
        python -m pytest ethoscope/tests/integration_api_tests/ \
          -v \
          --tb=short \
          --strict-markers \
          --strict-config \
          --no-cov \
          --junit-xml=junit-device-integration-${{ matrix.python-version }}.xml

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: device-test-results-${{ matrix.python-version }}
        path: src/ethoscope/junit-device-*.xml
        retention-days: 30

  test-node:
    name: Test Node Package (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # Test only versions used in deployment (same as device)
        python-version: ['3.9', '3.11', '3.12']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libopencv-dev \
          python3-opencv \
          libatlas-base-dev \
          libhdf5-dev \
          libcap-dev

    - name: Install node package with dependencies
      run: |
        cd src/node
        pip install --upgrade pip setuptools wheel
        pip install -e .[dev,testing]

    - name: Run node unit tests
      run: |
        cd src/node
        python -m pytest tests/unit/ \
          -v \
          --tb=short \
          --strict-markers \
          --strict-config \
          --junit-xml=junit-node-unit-${{ matrix.python-version }}.xml

    - name: Run node integration tests
      run: |
        cd src/node
        python -m pytest tests/integration/ \
          -v \
          --tb=short \
          --strict-markers \
          --strict-config \
          --junit-xml=junit-node-integration-${{ matrix.python-version }}.xml

    - name: Run node functional tests
      run: |
        cd src/node
        python -m pytest tests/functional/ \
          -v \
          --tb=short \
          --strict-markers \
          --strict-config \
          --junit-xml=junit-node-functional-${{ matrix.python-version }}.xml

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: node-test-results-${{ matrix.python-version }}
        path: src/node/junit-node-*.xml
        retention-days: 30

  coverage:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: [test-device, test-node]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libopencv-dev \
          python3-opencv \
          libatlas-base-dev \
          libhdf5-dev \
          libcap-dev

    - name: Install both packages with dev dependencies
      run: |
        pip install --upgrade pip setuptools wheel
        cd src/ethoscope && pip install -e .[dev,testing]
        cd ../node && pip install -e .[dev,testing]

    - name: Run device tests with coverage
      run: |
        cd src/ethoscope
        timeout 600 python -m pytest ethoscope/tests/ \
          --cov=ethoscope \
          --cov-report=xml:coverage-device.xml \
          --cov-report=html:htmlcov-device \
          --cov-report=term-missing

    - name: Run node tests with coverage
      run: |
        cd src/node
        timeout 300 python -m pytest tests/ \
          --cov=ethoscope_node \
          --cov-report=xml:coverage-node.xml \
          --cov-report=html:htmlcov-node \
          --cov-report=term-missing

    - name: Upload device coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./src/ethoscope/coverage-device.xml
        flags: device
        name: device-coverage
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Upload node coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./src/node/coverage-node.xml
        flags: node
        name: node-coverage
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      with:
        name: coverage-reports
        path: |
          src/ethoscope/coverage-device.xml
          src/ethoscope/htmlcov-device/
          src/node/coverage-node.xml
          src/node/htmlcov-node/
        retention-days: 30

